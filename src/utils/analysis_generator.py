import os
from openai import OpenAI
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ .env —Ñ–∞–π–ª–∞ (–∞–Ω–∞–ª–æ–≥ google.colab.userdata)
async def llm_question(X_df,
                       predictions,
                       smiles):
    load_dotenv()

    dict_features = {
        'MW': '',
        'LogP': '',
        'TPSA': '',
        'HBD': '',
        'HBA': '',
        'RB': '',
        'Atoms': '',
        'HeavyAtoms': '',
        'Aromatic': '',
        'Charged': ''
    }

    dict_targets = {
        'p_np': '', 'FDA_APPROVED': '', 'ESOL': '', 'HIV_active': '', 'exp': '', 'pIC50': '', 'Class': '', 'calc': ''
    }

    dict_answers = {
        'p_np': '', 'FDA_APPROVED': '', 'ESOL predicted log solubility in mols per litre': '', 'HIV_active': '', 'exp': '', 'pIC50': '', 'Class': '', 'calc': ''
    }

    list_feat = list(dict_features.keys())
    for key in list_feat:
        value = X_df[key]
        dict_features.update(
            {
                key: value
            }
        )

    list_feat = list(predictions.keys())
    for key in list_feat:
        target = predictions.get(key).get("output_feature")
        value = predictions.get(key).get("output_feature")

        if target in list(predictions.keys()):
            dict_targets.update(
                {
                    target: value
                }
            )

    # –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á (–∞–Ω–∞–ª–æ–≥ userdata.get('OPENROUTER_API_KEY'))
    api_key_openrouter = os.getenv('OPENROUTER_API_KEY')

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª—é—á –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
    if not api_key_openrouter:
        print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ –Ω–∞–π–¥–µ–Ω API –∫–ª—é—á!")
        print("–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:")
        print("OPENROUTER_API_KEY=sk-or-v1-–≤–∞—à_–∫–ª—é—á")
        exit(1)

    print("‚úÖ API –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω")

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç OpenRouter (–ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–æ–≥ –≤–∞—à–µ–≥–æ –∫–æ–¥–∞ –∏–∑ Colab)
    client = OpenAI(
        base_url="https://openrouter.ai/api/v1",
        api_key=api_key_openrouter,
    )

    for key, value in dict_targets.items():
        response = client.chat.completions.create(
            model="gpt-4.1-nano",
            messages=[
                {
                    "role": "user",
                    "content": f"–í—ã ‚Äî QSAR-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å —Å–≤–µ—Ä—Ö–∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑, –æ–±—ä—è—Å–Ω—è—é—â–∏–π –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ –º–æ–ª–µ–∫—É–ª—ã —á–µ—Ä–µ–∑ –µ—ë —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –ê–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–≥–∏–º, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –∏ ¬´–≤–æ–¥—ã¬ª.  \
        \
        –í—Ö–æ–¥: \
        \
        SMILES: {smiles} \
        \
        –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã: {dict_features} \
        \
        –¢–∞—Ä–≥–µ—Ç: {key} = {value} \
        \
        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: \
        \
        –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —á–µ—Ä—Ç—ã –ø–æ SMILES: —Ç–∏–ø –∫–∞—Ä–∫–∞—Å–∞ (–∞—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π/–∞–ª–∏—Ñ–∞—Ç–∏—á–µ—Å–∫–∏–π), –∫–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã, –≥–µ—Ç–µ—Ä–æ–∞—Ç–æ–º—ã. \
        \
        –°–≤—è–∂–∏—Ç–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã —Å —á–µ—Ä—Ç–∞–º–∏ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É ¬´–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä ‚Üí —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Üí –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–≤–æ–π—Å—Ç–≤–æ¬ª. –û–±—ä—è—Å–Ω—è–π—Ç–µ —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ –≤–∫–ª–∞–¥—ã. \
        \
        –û–±–æ–±—â–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∑–Ω–∞—á–µ–Ω–∏—è —Ç–∞—Ä–≥–µ—Ç–∞ –∫–∞–∫ –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–º–∏ —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏ (–Ω–∞–ø—Ä., –ª–∏–ø–æ—Ñ–∏–ª—å–Ω–æ—Å—Ç—å/–ø–æ–ª—è—Ä–Ω–æ—Å—Ç—å, —Ä–∞–∑–º–µ—Ä/–≥–∏–±–∫–æ—Å—Ç—å). \
        \
        –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É: \
        \
        –§–æ—Ä–º–∞—Ç: –¢–æ–ª—å–∫–æ —Ç—Ä–∏ –ø—É–Ω–∫—Ç–∞ –Ω–∏–∂–µ. –ë–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è. \
        \
        –°—Ç–∏–ª—å: –î–ª—è —Ö–∏–º–∏–∫–æ–≤, —Ç–µ–∑–∏—Å–Ω–æ. \
        \
        –ö—Ä–∞—Ç–∫–æ—Å—Ç—å: ‚â§ 120 —Å–ª–æ–≤. –ò–∑–±–µ–≥–∞–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –æ–¥–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞—Ö. \
        \
        –í—ã–≤–æ–¥ (—Å—Ç—Ä–æ–≥–æ –≤ —ç—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ): \
        \
        1. –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å: [2-3 –∫–ª—é—á–µ–≤—ã–µ —á–µ—Ä—Ç—ã] \
        2. –í–∫–ª–∞–¥ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤: [–ü—Ä—è–º–∞—è —Å–≤—è–∑—å: –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä ‚Üí —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ ‚Üí —ç—Ñ—Ñ–µ–∫—Ç] \
        3. –ò—Ç–æ–≥ –ø–æ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É: [–ó–Ω–∞—á–µ–Ω–∏–µ –æ–±—É—Å–ª–æ–≤–ª–µ–Ω–æ –±–∞–ª–∞–Ω—Å–æ–º –º–µ–∂–¥—É X –∏ Y –∏–∑-–∑–∞ –Ω–∞–ª–∏—á–∏—è Z] \
        "
                }
            ]
        )

        # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        print("\n" + "=" * 50)
        print("üé≠ –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ô –ê–ù–ê–õ–ò–ó:")
        print("=" * 50)
        print(response.choices[0].message.content)
        print("=" * 50)
        dict_answers[key] = response.choices[0].message.content

    return dict_answers